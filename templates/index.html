<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Analytics | AI</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%231a73e8'%3E%3Cpath d='M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z'/%3E%3C/svg%3E">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e8eaed 100%);
            color: #202124;
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Navigation Bar */
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(218, 220, 224, 0.3);
            padding: 0 24px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 20px rgba(60, 64, 67, 0.1);
            z-index: 1000;
            position: relative;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 500;
            color: #1a73e8;
            text-decoration: none;
        }

        .nav-brand .material-icons {
            font-size: 24px;
        }

        .nav-tabs {
            display: flex;
            gap: 8px;
        }

        .nav-tab {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #5f6368;
            background: transparent;
            border: none;
            font-family: 'Roboto', sans-serif;
        }

        .nav-tab.active {
            background: #1a73e8;
            color: white;
        }

        .nav-tab:hover:not(.active) {
            background: rgba(26, 115, 232, 0.1);
            color: #1a73e8;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 16px;
            position: relative;
        }

        .examples-dropdown {
            position: relative;
        }

        .examples-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(26, 115, 232, 0.1);
            border: 1px solid rgba(26, 115, 232, 0.2);
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #1a73e8;
            font-family: 'Roboto', sans-serif;
        }

        .examples-toggle:hover {
            background: rgba(26, 115, 232, 0.2);
        }

        .examples-toggle .material-icons {
            font-size: 16px;
            transition: transform 0.3s ease;
        }

        .examples-toggle.open .material-icons {
            transform: rotate(180deg);
        }

        .examples-dropdown-content {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(60, 64, 67, 0.2);
            border: 1px solid rgba(218, 220, 224, 0.3);
            min-width: 320px;
            max-width: 400px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px);
            transition: all 0.3s ease;
        }

        .examples-dropdown-content.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .examples-dropdown-header {
            padding: 16px 20px 12px;
            border-bottom: 1px solid rgba(218, 220, 224, 0.3);
            background: rgba(248, 249, 250, 0.8);
            border-radius: 12px 12px 0 0;
        }

        .examples-dropdown-header h3 {
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            font-weight: 500;
            color: #202124;
            margin: 0;
        }

        .examples-dropdown-list {
            padding: 8px;
        }

        .dropdown-example-item {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
            color: #3c4043;
            font-family: 'Roboto', sans-serif;
            line-height: 1.4;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .dropdown-example-item:hover {
            background: rgba(26, 115, 232, 0.1);
            color: #1a73e8;
        }

        .dropdown-example-item .material-icons {
            font-size: 16px;
            margin-top: 1px;
            opacity: 0.6;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            background: rgba(52, 168, 83, 0.1);
            color: #34a853;
        }

        .status-indicator.processing {
            background: rgba(255, 193, 7, 0.1);
            color: #ff8f00;
        }

        .status-indicator.error {
            background: rgba(234, 67, 53, 0.1);
            color: #ea4335;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(218, 220, 224, 0.3);
            padding: 24px;
            overflow-y: auto;
            box-shadow: 2px 0 20px rgba(60, 64, 67, 0.1);
        }

        .search-section {
            margin-bottom: 32px;
        }

        .section-title {
            font-family: 'Roboto', sans-serif;
            font-size: 16px;
            font-weight: 500;
            color: #202124;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-family: 'Roboto', sans-serif;
            font-size: 13px;
            font-weight: 500;
            color: #5f6368;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .form-select {
            width: 100%;
            padding: 12px 40px 12px 16px;
            border: 1px solid rgba(218, 220, 224, 0.6);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            color: #202124;
            cursor: pointer;
            outline: none;
            transition: all 0.3s ease;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%235f6368' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
        }

        .form-select:focus {
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
        }

        .search-input {
            width: 100%;
            padding: 16px;
            border: 1px solid rgba(218, 220, 224, 0.6);
            border-radius: 8px;
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
            resize: vertical;
            min-height: 80px;
            max-height: 160px;
            background: rgba(255, 255, 255, 0.9);
        }

        .search-input:focus {
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
        }

        .search-input::placeholder {
            color: #9aa0a6;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .button-row {
            display: flex;
            gap: 8px;
        }
        
        .button-row .btn {
            flex: 1;
        }

        .btn {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(218, 220, 224, 0.6);
            background: rgba(255, 255, 255, 0.9);
            color: #3c4043;
            border-radius: 8px;
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-align: center;
        }

        .btn:hover:not(:disabled) {
            background: #f8f9fa;
            border-color: #1a73e8;
        }

        .btn.primary {
            background: #1a73e8;
            color: white;
            border-color: #1a73e8;
        }

        .btn.primary:hover:not(:disabled) {
            background: #1557b0;
        }

        .btn.danger {
            background: #ea4335;
            color: white;
            border-color: #ea4335;
        }

        .btn.danger:hover:not(:disabled) {
            background: #d33b2c;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .examples-section {
            border-top: 1px solid rgba(218, 220, 224, 0.3);
            padding-top: 24px;
        }

        .example-item {
            padding: 12px;
            background: rgba(248, 249, 250, 0.8);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
            color: #3c4043;
            border: 1px solid transparent;
        }

        .example-item:hover {
            background: rgba(26, 115, 232, 0.1);
            border-color: rgba(26, 115, 232, 0.3);
        }

        .advanced-section {
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid rgba(218, 220, 224, 0.3);
        }

        .sql-input {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(218, 220, 224, 0.6);
            border-radius: 8px;
            font-family: 'Roboto Mono', 'Roboto', monospace;
            font-size: 12px;
            min-height: 60px;
            resize: vertical;
            outline: none;
            transition: all 0.3s ease;
            background: rgba(248, 249, 250, 0.9);
        }

        .sql-input:focus {
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
        }

        /* Results Area */
        .results-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.5);
        }

        .results-header {
            padding: 20px 32px;
            border-bottom: 1px solid rgba(218, 220, 224, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(248, 249, 250, 0.8);
            backdrop-filter: blur(10px);
        }

        .results-title {
            font-family: 'Roboto', sans-serif;
            font-size: 18px;
            font-weight: 500;
            color: #202124;
        }

        .results-meta {
            font-family: 'Roboto', sans-serif;
            font-size: 12px;
            color: #5f6368;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .results-content {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.3);
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #5f6368;
            text-align: center;
        }

        .empty-state .material-icons {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-family: 'Roboto', sans-serif;
            font-size: 20px;
            font-weight: 400;
            margin-bottom: 8px;
            color: #3c4043;
        }

        .empty-state p {
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            max-width: 400px;
        }

        .loading-state {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            flex-direction: column;
            color: #5f6368;
        }

        .spinner {
            border: 3px solid rgba(26, 115, 232, 0.1);
            border-top: 3px solid #1a73e8;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 200px;
            height: 2px;
            background: rgba(26, 115, 232, 0.1);
            border-radius: 1px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .progress-fill {
            height: 100%;
            background: #1a73e8;
            border-radius: 1px;
            animation: progress 2s ease-in-out infinite;
        }

        @keyframes progress {
            0% { width: 0%; transform: translateX(-100%); }
            50% { width: 100%; transform: translateX(0%); }
            100% { width: 100%; transform: translateX(100%); }
        }

        .error-state {
            background: rgba(234, 67, 53, 0.1);
            border: 1px solid rgba(234, 67, 53, 0.2);
            border-radius: 8px;
            padding: 16px;
            color: #ea4335;
            font-size: 14px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .success-state {
            background: rgba(52, 168, 83, 0.1);
            border: 1px solid rgba(52, 168, 83, 0.2);
            border-radius: 8px;
            padding: 16px;
            color: #34a853;
            font-size: 14px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .response-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 12px rgba(60, 64, 67, 0.1);
            border: 1px solid rgba(218, 220, 224, 0.3);
        }

        .response-text {
            white-space: normal;
            line-height: 1.6;
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            color: #202124;
        }

        .response-text h1, .response-text h2, .response-text h3 {
            color: #202124;
            margin: 16px 0 8px 0;
            font-family: 'Roboto', sans-serif;
        }

        .response-text h1 { font-size: 18px; font-weight: 500; }
        .response-text h2 { font-size: 16px; font-weight: 500; }
        .response-text h3 { font-size: 15px; font-weight: 500; }

        .response-text p {
            margin: 8px 0;
            line-height: 1.5;
        }

        .response-text ul, .response-text ol {
            margin: 8px 0;
            padding-left: 20px;
        }

        .response-text li {
            margin: 4px 0;
            line-height: 1.4;
        }

        .response-text code {
            background: rgba(248, 249, 250, 0.8);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Roboto Mono', monospace;
            font-size: 13px;
            color: #ea4335;
        }

        .response-text pre {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 12px 0;
            font-family: 'Roboto Mono', monospace;
            font-size: 12px;
            line-height: 1.3;
            border: 1px solid rgba(218, 220, 224, 0.6);
        }

        .response-text blockquote {
            border-left: 3px solid #1a73e8;
            margin: 12px 0;
            padding: 8px 16px;
            background: rgba(26, 115, 232, 0.05);
            border-radius: 0 6px 6px 0;
            font-style: italic;
        }

        .response-text strong {
            font-weight: 500;
            color: #202124;
        }

        .response-text em {
            font-style: italic;
            color: #5f6368;
        }

        .analysis-section {
            margin: 12px 0;
            padding: 0;
        }

        .analysis-point {
            margin: 6px 0;
            padding: 0;
            line-height: 1.4;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 13px;
            border: 1px solid rgba(218, 220, 224, 0.6);
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }

        .data-table th {
            background: #f8f9fa;
            padding: 12px 16px;
            text-align: left;
            font-weight: 500;
            border-bottom: 1px solid rgba(218, 220, 224, 0.6);
            color: #3c4043;
            font-family: 'Roboto', sans-serif;
        }

        .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(218, 220, 224, 0.3);
            color: #202124;
            font-family: 'Roboto', sans-serif;
        }

        .data-table tr:hover {
            background: rgba(248, 249, 250, 0.8);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                width: 280px;
            }

            .results-content {
                padding: 24px;
            }
        }

        @media (max-width: 768px) {
            .nav-tabs {
                display: none;
            }

            .sidebar {
                position: fixed;
                left: -320px;
                top: 64px;
                height: calc(100vh - 64px);
                z-index: 999;
                transition: left 0.3s ease;
            }

            .sidebar.open {
                left: 0;
            }

            .results-area {
                width: 100%;
            }

            .nav-left {
                gap: 12px;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(95, 99, 104, 0.3);
            border-radius: 3px;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 12px rgba(60, 64, 67, 0.1);
            border: 1px solid rgba(218, 220, 224, 0.3);
        }

        .chart-title {
            font-family: 'Roboto', sans-serif;
            font-size: 16px;
            font-weight: 500;
            color: #202124;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-placeholder {
            width: 100%;
            height: 300px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #5f6368;
            border: 2px dashed #dadce0;
        }

        .chart-placeholder .material-icons {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.6;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
        }

        .chart-summary {
            background: rgba(26, 115, 232, 0.1);
            border: 1px solid rgba(26, 115, 232, 0.2);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .chart-summary h3 {
            color: #1a73e8;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .chart-summary p {
            color: #3c4043;
            font-size: 13px;
            margin: 4px 0;
        }

        .bar-chart {
            display: flex;
            align-items: flex-end;
            height: 200px;
            gap: 8px;
            padding: 16px;
            background: #fafafa;
            border-radius: 8px;
            margin: 16px 0;
        }

        .bar {
            flex: 1;
            background: linear-gradient(to top, #1a73e8, #4285f4);
            border-radius: 4px 4px 0 0;
            min-height: 10px;
            position: relative;
            transition: all 0.3s ease;
        }

        .bar:hover {
            background: linear-gradient(to top, #1557b0, #1a73e8);
        }

        .bar-label {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #5f6368;
            width: 100px;
            text-align: center;
            word-wrap: break-word;
        }

        .bar-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            color: #202124;
            font-weight: 500;
            background: white;
            padding: 2px 6px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .bar:hover .bar-value {
            opacity: 1;
        }

        .trend-line {
            height: 200px;
            background: #fafafa;
            border-radius: 8px;
            margin: 16px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .trend-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .trend-up { color: #34a853; }
        .trend-down { color: #ea4335; }
        .trend-stable { color: #fbbc04; }

        /* Enhanced Response Formatting Styles */
        .highlight-text {
            color: #1a73e8;
            font-weight: 600;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 24px 0 16px 0;
            padding: 12px 16px;
            border-radius: 8px;
            font-weight: 500;
        }
        
        .section-header.level-1 {
            background: linear-gradient(135deg, #1a73e8, #4285f4);
            color: white;
            font-size: 20px;
        }
        
        .section-header.level-2 {
            background: rgba(26, 115, 232, 0.1);
            color: #1a73e8;
            border-left: 4px solid #1a73e8;
            font-size: 18px;
        }
        
        .section-header.level-3 {
            background: rgba(52, 168, 83, 0.1);
            color: #34a853;
            border-left: 4px solid #34a853;
            font-size: 16px;
        }
        
        .code-block {
            margin: 16px 0;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid rgba(218, 220, 224, 0.6);
        }
        
        .code-header {
            background: #f8f9fa;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 500;
            color: #5f6368;
            border-bottom: 1px solid rgba(218, 220, 224, 0.6);
        }
        
        .sql-block .code-header {
            background: rgba(26, 115, 232, 0.1);
            color: #1a73e8;
        }
        
        .code-block pre {
            margin: 0;
            background: white;
            padding: 16px;
        }
        
        .inline-code {
            background: rgba(26, 115, 232, 0.1);
            color: #1a73e8;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Roboto Mono', monospace;
            font-size: 13px;
            font-weight: 500;
        }
        
        .formatted-list {
            margin: 12px 0;
            padding-left: 0;
        }
        
        .formatted-list.insights {
            background: rgba(255, 193, 7, 0.1);
            border-radius: 8px;
            padding: 12px;
        }
        
        .formatted-list.recommendations {
            background: rgba(52, 168, 83, 0.1);
            border-radius: 8px;
            padding: 12px;
        }
        
        .formatted-list.summary {
            background: rgba(26, 115, 232, 0.1);
            border-radius: 8px;
            padding: 12px;
        }
        
        .list-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin: 8px 0;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }
        
        .list-item:hover {
            background: rgba(248, 249, 250, 0.8);
        }
        
        .list-icon {
            font-size: 16px;
            margin-top: 2px;
            flex-shrink: 0;
        }
        
        .insights .list-icon {
            color: #fbbc04;
        }
        
        .recommendations .list-icon {
            color: #34a853;
        }
        
        .paragraph.summary {
            background: rgba(26, 115, 232, 0.05);
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid #1a73e8;
        }
        
        .paragraph.insights {
            background: rgba(255, 193, 7, 0.05);
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid #fbbc04;
        }
        
        .paragraph.recommendations {
            background: rgba(52, 168, 83, 0.05);
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid #34a853;
        }
        
        .chart-suggestions {
            background: linear-gradient(135deg, rgba(26, 115, 232, 0.1), rgba(66, 133, 244, 0.1));
            border: 1px solid rgba(26, 115, 232, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .chart-suggestions h3 {
            color: #1a73e8;
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .suggestion-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
        }
        
        .suggestion-card {
            background: white;
            border: 1px solid rgba(218, 220, 224, 0.6);
            border-radius: 8px;
            padding: 16px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .suggestion-card:hover {
            border-color: #1a73e8;
            box-shadow: 0 2px 8px rgba(26, 115, 232, 0.2);
            transform: translateY(-2px);
        }
        
        .suggestion-title {
            font-weight: 500;
            color: #202124;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .suggestion-description {
            font-size: 12px;
            color: #5f6368;
            margin-bottom: 8px;
        }
        
        .suggestion-details {
            font-size: 11px;
            color: #1a73e8;
            background: rgba(26, 115, 232, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
        }
        
        /* Dynamic Dashboard Styles */
        .dashboard-container {
            padding: 24px;
            background: rgba(255, 255, 255, 0.3);
            overflow-y: auto;
            height: 100%;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding: 20px;
            background: linear-gradient(135deg, #1a73e8, #4285f4);
            border-radius: 12px;
            color: white;
        }
        
        .dashboard-title {
            font-size: 28px;
            font-weight: 500;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .dashboard-meta {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }
        
        .kpi-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(60, 64, 67, 0.1);
            border: 1px solid rgba(218, 220, 224, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(60, 64, 67, 0.15);
        }
        
        .kpi-card.blue { border-left: 4px solid #1a73e8; }
        .kpi-card.green { border-left: 4px solid #34a853; }
        .kpi-card.gold { border-left: 4px solid #fbbc04; }
        .kpi-card.red { border-left: 4px solid #ea4335; }
        
        .kpi-icon {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 32px;
            opacity: 0.1;
        }
        
        .kpi-icon.blue { color: #1a73e8; }
        .kpi-icon.green { color: #34a853; }
        .kpi-icon.gold { color: #fbbc04; }
        .kpi-icon.red { color: #ea4335; }
        
        .kpi-title {
            font-size: 14px;
            color: #5f6368;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .kpi-value {
            font-size: 32px;
            font-weight: 700;
            color: #202124;
            margin-bottom: 4px;
        }
        
        .kpi-change {
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .kpi-change.positive { color: #34a853; }
        .kpi-change.negative { color: #ea4335; }
        .kpi-change.neutral { color: #5f6368; }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(60, 64, 67, 0.1);
            border: 1px solid rgba(218, 220, 224, 0.3);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(218, 220, 224, 0.3);
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: 500;
            color: #202124;
        }
        
        .chart-actions {
            display: flex;
            gap: 8px;
        }
        
        .chart-action-btn {
            background: none;
            border: 1px solid rgba(218, 220, 224, 0.6);
            border-radius: 6px;
            padding: 6px;
            cursor: pointer;
            color: #5f6368;
            transition: all 0.2s ease;
        }
        
        .chart-action-btn:hover {
            background: #f8f9fa;
            color: #202124;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .insights-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(60, 64, 67, 0.1);
            border: 1px solid rgba(218, 220, 224, 0.3);
            margin-bottom: 24px;
        }
        
        .insights-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .insights-title {
            font-size: 20px;
            font-weight: 500;
            color: #202124;
        }
        
        .insight-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid rgba(218, 220, 224, 0.2);
        }
        
        .insight-item:last-child {
            border-bottom: none;
        }
        
        .insight-icon {
            color: #fbbc04;
            margin-top: 2px;
        }
        
        .insight-text {
            flex: 1;
            font-size: 14px;
            color: #3c4043;
            line-height: 1.4;
        }
        
        .forecast-section {
            background: linear-gradient(135deg, rgba(26, 115, 232, 0.1), rgba(66, 133, 244, 0.05));
            border: 1px solid rgba(26, 115, 232, 0.2);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .forecast-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .forecast-title {
            font-size: 20px;
            font-weight: 500;
            color: #1a73e8;
        }
        
        .forecast-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }
        
        .forecast-values {
            background: white;
            border-radius: 8px;
            padding: 16px;
        }
        
        .forecast-trend {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 12px;
        }
        
        .trend-up { color: #34a853; }
        .trend-down { color: #ea4335; }
        .trend-stable { color: #fbbc04; }
        
        .forecast-next-values {
            font-size: 14px;
            color: #5f6368;
        }
        
        .forecast-confidence {
            background: rgba(26, 115, 232, 0.1);
            color: #1a73e8;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
            margin-top: 8px;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .metric-item {
            background: rgba(248, 249, 250, 0.8);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }
        
        .metric-label {
            font-size: 12px;
            color: #5f6368;
            margin-bottom: 4px;
        }
        
        .metric-value {
            font-size: 18px;
            font-weight: 600;
            color: #202124;
        }
        
        .dashboard-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }
        
        .dashboard-tab {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(218, 220, 224, 0.6);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #5f6368;
        }
        
        .dashboard-tab.active {
            background: #1a73e8;
            color: white;
            border-color: #1a73e8;
        }
        
        .dashboard-tab:hover:not(.active) {
            background: #f8f9fa;
            color: #202124;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .no-data-state {
            text-align: center;
            padding: 40px;
            color: #5f6368;
        }
        
        .no-data-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .export-options {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid rgba(218, 220, 224, 0.6);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(60, 64, 67, 0.1);
            z-index: 1000;
            min-width: 120px;
            display: none;
        }
        
        .export-option {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s ease;
        }
        
        .export-option:hover {
            background: #f8f9fa;
        }
        
        .chart-card:hover .export-options {
            display: block;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Navigation Bar -->
        <nav class="navbar">
            <div class="nav-left">
                <a href="/" class="nav-brand">
                    <span class="material-icons">analytics</span>
                    Data Analytics
                </a>
                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="switchTab('dashboard')">Dashboard</button>
                    <button class="nav-tab" onclick="switchTab('charts')">
                        <span class="material-icons" style="font-size: 16px; margin-right: 4px;">analytics</span>
                        Charts & KPIs
                    </button>
                    <button class="nav-tab" onclick="switchTab('settings')">Settings</button>
                </div>
            </div>
            <div class="nav-right">
                <div class="examples-dropdown">
                    <button class="examples-toggle" onclick="toggleExamples()">
                        <span class="material-icons">help_outline</span>
                        Examples
                        <span class="material-icons">expand_more</span>
                    </button>
                    <div class="examples-dropdown-content" id="examplesDropdown">
                        <div class="examples-dropdown-header">
                            <h3>Example Questions</h3>
                        </div>
                        <div class="examples-dropdown-list" id="navExamplesList">
                            <!-- Examples will be loaded here -->
                        </div>
                    </div>
                </div>
                <div class="status-indicator" id="statusIndicator">
                    <div class="status-dot"></div>
                    <span id="statusText">Ready</span>
                </div>
            </div>
        </nav>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Sidebar -->
            <aside class="sidebar" id="sidebar">
                <!-- Search Section -->
                <div class="search-section">
                    <h3 class="section-title">
                        <span class="material-icons">search</span>
                        Query Assistant
                    </h3>
                    
                    <div class="form-group">
                        <label class="form-label" for="tableSelect">Select Table</label>
                        <select id="tableSelect" class="form-select">
                            <option value="">Loading tables...</option>
                        </select>
                        <div style="font-size: 11px; color: #9aa0a6; margin-top: 4px;">
                            Choose the data table you want to analyze
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="modelSelect">AI Model</label>
                        <select id="modelSelect" class="form-select">
                            <option value="snowflake-arctic">Snowflake Arctic</option>
                            <option value="llama3-8b">Llama3 8B</option>
                            <option value="claude-4-sonnet">Claude 4 Sonnet</option>
                            <option value="mistral-large">Mistral Large</option>
                            <option value="deepseek-r1">Deepseek R1</option>
                            <option value="openai-gpt-4.1">OpenAI GPT-4.1</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="temperatureSlider">Temperature (Creativity)</label>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <input type="range" id="temperatureSlider" min="0" max="1" step="0.1" value="0.7" 
                                   style="flex: 1; height: 6px; background: #ddd; outline: none; border-radius: 3px;">
                            <span id="temperatureValue" style="font-size: 12px; color: #5f6368; min-width: 30px;">0.7</span>
                        </div>
                        <div style="font-size: 11px; color: #9aa0a6; margin-top: 4px;">
                            Lower = More focused • Higher = More creative
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="questionInput">Your Question</label>
                        <textarea id="questionInput" class="search-input" 
                                  placeholder="What insights would you like about your data?"
                                  rows="3"></textarea>
                    </div>

                    <div class="button-group">
                        <div class="button-row">
                            <button class="btn primary" id="analyzeBtn" onclick="submitQuestion()">
                                <span class="material-icons">auto_awesome</span>
                                Analyze Data
                            </button>
                            <button class="btn" onclick="clearResults()">
                                <span class="material-icons">refresh</span>
                                Clear Results
                            </button>
                            <button class="btn danger" id="cancelBtn" onclick="cancelRequest()" style="display: none;">
                                <span class="material-icons">close</span>
                                Cancel Request
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Examples Section -->
                <!-- <div class="examples-section">
                    <h3 class="section-title">
                        <span class="material-icons">quiz</span>
                        Quick Examples
                    </h3>
                    <div id="examplesList">
                        <div class="example-item" onclick="loadSampleQuestions()">
                            Click "Examples" in navbar for more options
                        </div>
                    </div>
                </div> -->


            </aside>

            <!-- Results Area -->
            <main class="results-area" id="resultsArea">
                <div class="results-header">
                    <h2 class="results-title" id="resultsTitle">Analysis Results</h2>
                    <div class="results-meta" id="resultsMetadata"></div>
                </div>
                <div class="results-content" id="resultsContent">
                    <div class="empty-state">
                        <span class="material-icons">psychology</span>
                        <h3>Ready to analyze your data</h3>
                        <p>Ask a question about your data using natural language, or execute a custom SQL query to get started.</p>
                    </div>
                </div>
            </main>



            <!-- Charts & KPIs Area -->
            <main class="results-area" id="chartsArea" style="display: none;">
                <div class="dashboard-container">
                    <!-- Dashboard Header -->
                    <div class="dashboard-header">
                        <div>
                            <h1 class="dashboard-title">
                                <span class="material-icons">dashboard</span>
                                Analytics Dashboard
                            </h1>
                            <div class="dashboard-meta" id="dashboardMeta">
                                Real-time insights and data visualizations
                            </div>
                        </div>
                        <div>
                            <button class="btn" id="refreshDashboard" onclick="refreshDashboard()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">
                                <span class="material-icons">refresh</span>
                                Refresh
                            </button>
                        </div>
                    </div>

                    <!-- Dashboard Tabs -->
                    <div class="dashboard-tabs">
                        <div class="dashboard-tab active" onclick="switchDashboardTab('overview')">
                            <span class="material-icons" style="font-size: 16px; margin-right: 8px;">insights</span>
                            Overview
                        </div>
                        <div class="dashboard-tab" onclick="switchDashboardTab('charts')">
                            <span class="material-icons" style="font-size: 16px; margin-right: 8px;">bar_chart</span>
                            Charts
                        </div>
                        <div class="dashboard-tab" onclick="switchDashboardTab('forecast')">
                            <span class="material-icons" style="font-size: 16px; margin-right: 8px;">trending_up</span>
                            Forecast
                        </div>
                    </div>

                    <!-- KPI Grid -->
                    <div class="kpi-grid" id="kpiGrid">
                        <!-- KPIs will be dynamically generated here -->
                    </div>

                    <!-- Metrics Grid -->
                    <div class="metrics-grid" id="metricsGrid">
                        <!-- Metrics will be dynamically generated here -->
                    </div>

                    <!-- Charts Grid -->
                    <div class="charts-grid" id="chartsGrid">
                        <!-- Charts will be dynamically generated here -->
                    </div>

                    <!-- Insights Section -->
                    <div class="insights-section" id="insightsSection" style="display: none;">
                        <div class="insights-header">
                            <span class="material-icons insight-icon">lightbulb</span>
                            <h3 class="insights-title">Key Insights</h3>
                        </div>
                        <div id="insightsList">
                            <!-- Insights will be dynamically generated here -->
                        </div>
                    </div>

                    <!-- Forecast Section -->
                    <div class="forecast-section" id="forecastSection" style="display: none;">
                        <div class="forecast-header">
                            <span class="material-icons">trending_up</span>
                            <h3 class="forecast-title">Forecast & Trends</h3>
                        </div>
                        <div class="forecast-content" id="forecastContent">
                            <!-- Forecast data will be dynamically generated here -->
                        </div>
                    </div>

                    <!-- No Data State -->
                    <div class="no-data-state" id="noDashboardData">
                        <div class="no-data-icon">
                            <span class="material-icons">analytics</span>
                        </div>
                        <h3>No Dashboard Data Available</h3>
                        <p>Run a query from the Dashboard tab to generate dynamic KPIs, charts, and insights.</p>
                    </div>
                </div>
            </main>

            <!-- Settings Area -->
            <main class="results-area" id="settingsArea" style="display: none;">
                <div class="results-header">
                    <h2 class="results-title">Settings</h2>
                    <div class="results-meta"></div>
                </div>
                <div class="results-content" id="settingsContent">
                    <div class="response-content">
                        <h3>Application Settings</h3>
                        <div class="form-group">
                            <label class="form-label">Default Model</label>
                            <select class="form-select" id="defaultModel">
                                <option value="snowflake-arctic">Snowflake Arctic</option>
                                <option value="llama3-8b">Llama3 8B</option>
                                <option value="llama3-70b">Llama3 70B</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Theme</label>
                            <select class="form-select">
                                <option value="light">Light</option>
                                <option value="dark">Dark (Coming Soon)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Auto-save Queries</label>
                            <select class="form-select">
                                <option value="true">Enabled</option>
                                <option value="false">Disabled</option>
                            </select>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        let isProcessing = false;
        let currentRequest = null;
        let requestController = null;
        let availableTables = [];
        let selectedTable = '';

        // Auto-resize textarea
        document.getElementById('questionInput').addEventListener('input', autoResizeTextarea);
        
        // Temperature slider update
        document.getElementById('temperatureSlider').addEventListener('input', function(e) {
            document.getElementById('temperatureValue').textContent = e.target.value;
        });

        // Table selection change handler
        document.getElementById('tableSelect').addEventListener('change', function(e) {
            selectedTable = e.target.value;
            if (selectedTable) {
                loadSampleQuestions(selectedTable);
                updateQuestionPlaceholder(selectedTable);
            }
        });

        function autoResizeTextarea(e) {
            const textarea = e.target;
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 160) + 'px';
        }

        // Load tables and sample questions on page load
        window.onload = function() {
            loadAvailableTables();
            updateStatus('ready', 'Ready');
        };

        async function loadAvailableTables() {
            try {
                const response = await fetch('/api/tables');
                const data = await response.json();
                
                const tableSelect = document.getElementById('tableSelect');
                tableSelect.innerHTML = '';
                
                if (data.tables && data.tables.length > 0) {
                    availableTables = data.tables;
                    
                    data.tables.forEach(table => {
                        const option = document.createElement('option');
                        option.value = table.full_name;
                        option.textContent = `${table.name} (${table.schema})`;
                        tableSelect.appendChild(option);
                    });
                    
                    // Select the first table by default
                    selectedTable = data.tables[0].full_name;
                    tableSelect.value = selectedTable;
                    
                    // Load sample questions for the selected table
                    loadSampleQuestions(selectedTable);
                    updateQuestionPlaceholder(selectedTable);
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No tables available';
                    tableSelect.appendChild(option);
                }
                
            } catch (error) {
                console.error('Error loading tables:', error);
                const tableSelect = document.getElementById('tableSelect');
                tableSelect.innerHTML = '<option value="">Error loading tables</option>';
            }
        }



        function updateQuestionPlaceholder(tableName) {
            const questionInput = document.getElementById('questionInput');
            const tableShortName = tableName.split('.').pop().replace('_', ' ');
            questionInput.placeholder = `What insights would you like about your ${tableShortName} data?`;
        }

        function updateStatus(type, message) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            
            indicator.className = 'status-indicator';
            if (type === 'processing') {
                indicator.classList.add('processing');
            } else if (type === 'error') {
                indicator.classList.add('error');
            }
            
            text.textContent = message;
        }

        function setProcessingState(processing) {
            isProcessing = processing;
            
            const analyzeBtn = document.getElementById('analyzeBtn');
            const cancelBtn = document.getElementById('cancelBtn');

            const modelSelect = document.getElementById('modelSelect');
            const tableSelect = document.getElementById('tableSelect');
            
            if (processing) {
                analyzeBtn.style.display = 'none';
                cancelBtn.style.display = 'flex';

                modelSelect.disabled = true;
                tableSelect.disabled = true;
                updateStatus('processing', 'Processing...');
            } else {
                analyzeBtn.style.display = 'flex';
                cancelBtn.style.display = 'none';

                modelSelect.disabled = false;
                tableSelect.disabled = false;
                updateStatus('ready', 'Ready');
            }
        }

        function cancelRequest() {
            if (requestController) {
                requestController.abort();
                requestController = null;
            }
            setProcessingState(false);
            updateStatus('ready', 'Request cancelled');
        }

        async function loadSampleQuestions(tableName = null) {
            try {
                const url = tableName ? `/api/sample-questions?table=${encodeURIComponent(tableName)}` : '/api/sample-questions';
                const response = await fetch(url);
                const data = await response.json();
                
                // Load examples in navbar dropdown
                const navExamplesList = document.getElementById('navExamplesList');
                navExamplesList.innerHTML = '';
                
                data.questions.forEach(question => {
                    const div = document.createElement('div');
                    div.className = 'dropdown-example-item';
                    div.innerHTML = `
                        <span class="material-icons">lightbulb_outline</span>
                        <span>${question}</span>
                    `;
                    div.onclick = () => {
                        if (!isProcessing) {
                            document.getElementById('questionInput').value = question;
                            autoResizeTextarea({target: document.getElementById('questionInput')});
                            closeExamples();
                        }
                    };
                    navExamplesList.appendChild(div);
                });
                
                // Keep a simple placeholder in sidebar
                const examplesList = document.getElementById('examplesList');
                if (examplesList) {
                    examplesList.innerHTML = `
                        <div class="example-item" onclick="document.querySelector('.examples-toggle').click()">
                            <span class="material-icons" style="font-size: 16px; margin-right: 8px;">arrow_upward</span>
                            View examples in navbar above
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error loading sample questions:', error);
            }
        }

        function toggleExamples() {
            const dropdown = document.getElementById('examplesDropdown');
            const toggle = document.querySelector('.examples-toggle');
            
            const isOpen = dropdown.classList.contains('show');
            
            if (isOpen) {
                closeExamples();
            } else {
                dropdown.classList.add('show');
                toggle.classList.add('open');
                
                // Close when clicking outside
                setTimeout(() => {
                    document.addEventListener('click', closeExamplesOnOutsideClick);
                }, 100);
            }
        }

        function closeExamples() {
            const dropdown = document.getElementById('examplesDropdown');
            const toggle = document.querySelector('.examples-toggle');
            
            dropdown.classList.remove('show');
            toggle.classList.remove('open');
            document.removeEventListener('click', closeExamplesOnOutsideClick);
        }

        function closeExamplesOnOutsideClick(e) {
            const dropdown = document.querySelector('.examples-dropdown');
            if (!dropdown.contains(e.target)) {
                closeExamples();
            }
        }

        async function submitQuestion() {
            if (isProcessing) return;
            
            const question = document.getElementById('questionInput').value.trim();
            const model = document.getElementById('modelSelect').value;
            const temperature = parseFloat(document.getElementById('temperatureSlider').value);
            const table = selectedTable || document.getElementById('tableSelect').value;
            
            if (!question) {
                document.getElementById('questionInput').focus();
                return;
            }
            
            if (!table) {
                alert('Please select a table to analyze');
                return;
            }
            

            
            setProcessingState(true);
            showLoadingState();
            
            try {
                requestController = new AbortController();
                
                const response = await fetch('/api/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        question: question,
                        model: model,
                        temperature: temperature,
                        table: table
                    }),
                    signal: requestController.signal
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    displayResults(data);
                    updateStatus('ready', 'Analysis complete');
                } else {
                    displayError(data.error);
                    updateStatus('error', 'Analysis failed');
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('Request was cancelled');
                } else {
                    displayError(`Network error: ${error.message}`);
                    updateStatus('error', 'Network error');
                }
            } finally {
                setProcessingState(false);
                requestController = null;
            }
        }
        
        function clearResults() {
            // Clear main results area
            const resultsContent = document.getElementById('resultsContent');
            const metadata = document.getElementById('resultsMetadata');
            
            if (resultsContent) {
                resultsContent.innerHTML = `
                    <div class="empty-state">
                        <span class="material-icons">analytics</span>
                        <h3>No Analysis Yet</h3>
                        <p>Ask a question about your data to get started with AI-powered insights.</p>
                    </div>
                `;
            }
            
            if (metadata) {
                metadata.innerHTML = '';
            }
            
            // Clear dashboard
            clearPreviousDashboard();
            
            // Show no data state for dashboard
            const noDashboardData = document.getElementById('noDashboardData');
            if (noDashboardData) {
                noDashboardData.style.display = 'block';
            }
            
            // Clear question input
            const questionInput = document.getElementById('questionInput');
            if (questionInput) {
                questionInput.value = '';
                autoResizeTextarea({target: questionInput});
            }
            
            updateStatus('ready', 'Ready');
            console.log('All results cleared');
        }

        function showLoadingState() {
            const resultsContent = document.getElementById('resultsContent');
            resultsContent.innerHTML = `
                <div class="loading-state">
                    <div class="spinner"></div>
                    <div class="progress-bar">
                        <div class="progress-fill"></div>
                    </div>
                    <p>Analyzing your request...</p>
                </div>
            `;
        }

        function displayResults(data) {
            const resultsContent = document.getElementById('resultsContent');
            const metadata = document.getElementById('resultsMetadata');
            
            const timestamp = new Date(data.timestamp).toLocaleString();
            metadata.innerHTML = `
                <span>Model: ${data.model_used}</span>
                <span>•</span>
                <span>${timestamp}</span>
            `;
                            
            // Format the response text for better readability
            const formattedResponse = formatAIResponse(data.response);
            let content = `<div class="response-content">
                <div class="response-text">${formattedResponse}</div>
            </div>`;
            
            resultsContent.innerHTML = content;
            
            // Generate dynamic dashboard if dashboard data is available
            if (data.dashboard_data) {
                generateDynamicDashboard(data.dashboard_data, data.table_used);
            }
        }
        
        // Global variables for dashboard
        let activeCharts = {};
        let currentDashboardData = null;
        let currentDashboardTab = 'overview';
        
        function clearPreviousDashboard() {
            // Clear all existing charts
            Object.keys(activeCharts).forEach(chartId => {
                if (activeCharts[chartId]) {
                    try {
                        activeCharts[chartId].destroy();
                    } catch (e) {
                        console.warn('Error destroying chart:', e);
                    }
                }
            });
            activeCharts = {};
            
            // Clear dashboard content
            const kpiGrid = document.getElementById('kpiGrid');
            const metricsGrid = document.getElementById('metricsGrid');
            const chartsGrid = document.getElementById('chartsGrid');
            const insightsContent = document.getElementById('insightsContent');
            const forecastContent = document.getElementById('forecastContent');
            
            if (kpiGrid) kpiGrid.innerHTML = '';
            if (metricsGrid) metricsGrid.innerHTML = '';
            if (chartsGrid) chartsGrid.innerHTML = '';
            if (insightsContent) insightsContent.innerHTML = '';
            if (forecastContent) forecastContent.innerHTML = '';
            
            // Hide sections
            const forecastSection = document.getElementById('forecastSection');
            if (forecastSection) forecastSection.style.display = 'none';
            
            console.log('Previous dashboard cleared');
        }
        
        function generateDynamicDashboard(dashboardData, tableName) {
            // Clear previous dashboard first
            clearPreviousDashboard();
            
            currentDashboardData = dashboardData;
            
            // Update dashboard meta information
            const dashboardMeta = document.getElementById('dashboardMeta');
            if (dashboardMeta) {
                dashboardMeta.innerHTML = `Analyzing ${tableName} • Last updated: ${dashboardData.metrics?.last_updated || 'Now'}`;
            }
            
            // Generate KPIs
            generateKPIs(dashboardData.kpis || []);
            
            // Generate Metrics
            generateMetrics(dashboardData.metrics || {});
            
            // Generate Charts
            generateCharts(dashboardData.charts || []);
            
            // Generate Insights
            generateInsights(dashboardData.insights || []);
            
            // Generate Forecast
            if (dashboardData.forecast) {
                generateForecast(dashboardData.forecast);
            }
            
            // Hide no-data state
            const noDashboardData = document.getElementById('noDashboardData');
            if (noDashboardData) {
                noDashboardData.style.display = 'none';
            }
        }
        
        function generateKPIs(kpis) {
            const kpiGrid = document.getElementById('kpiGrid');
            if (!kpiGrid || !kpis.length) return;
            
            let kpiHTML = '';
            kpis.forEach(kpi => {
                const formattedValue = formatKPIValue(kpi.value, kpi.format);
                kpiHTML += `
                    <div class="kpi-card ${kpi.color}">
                        <div class="kpi-icon ${kpi.color}">
                            <span class="material-icons">${kpi.icon}</span>
                        </div>
                        <div class="kpi-title">${kpi.title}</div>
                        <div class="kpi-value">${formattedValue}</div>
                        <div class="kpi-change neutral">
                            <span class="material-icons" style="font-size: 14px;">info</span>
                            Real-time data
                        </div>
                    </div>
                `;
            });
            
            kpiGrid.innerHTML = kpiHTML;
        }
        
        function formatKPIValue(value, format) {
            if (format === 'number') {
                return typeof value === 'number' ? value.toLocaleString() : value;
            } else if (format === 'decimal') {
                return typeof value === 'number' ? value.toFixed(2) : value;
            } else if (format === 'percentage') {
                return typeof value === 'number' ? `${value.toFixed(1)}%` : value;
            }
            return value;
        }
        
        function generateMetrics(metrics) {
            const metricsGrid = document.getElementById('metricsGrid');
            if (!metricsGrid || !Object.keys(metrics).length) return;
            
            let metricsHTML = '';
            Object.entries(metrics).forEach(([key, value]) => {
                const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                metricsHTML += `
                    <div class="metric-item">
                        <div class="metric-label">${label}</div>
                        <div class="metric-value">${value}</div>
                    </div>
                `;
            });
            
            metricsGrid.innerHTML = metricsHTML;
        }
        
        function generateCharts(charts) {
            const chartsGrid = document.getElementById('chartsGrid');
            if (!chartsGrid || !charts.length) return;
            
            let chartsHTML = '';
            charts.forEach((chart, index) => {
                const chartId = `chart_${chart.id || index}`;
                chartsHTML += `
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">${chart.title}</h3>
                            <div class="chart-actions">
                                <button class="chart-action-btn" onclick="exportChart('${chartId}')" title="Export Chart">
                                    <span class="material-icons" style="font-size: 16px;">download</span>
                                </button>
                                <button class="chart-action-btn" onclick="refreshChart('${chartId}')" title="Refresh Chart">
                                    <span class="material-icons" style="font-size: 16px;">refresh</span>
                                </button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="${chartId}" width="400" height="300"></canvas>
                        </div>
                    </div>
                `;
            });
            
            chartsGrid.innerHTML = chartsHTML;
            
            // Create actual Chart.js charts
            setTimeout(() => {
                charts.forEach((chart, index) => {
                    const chartId = `chart_${chart.id || index}`;
                    createChart(chartId, chart);
                });
            }, 100);
        }
        
        function createChart(canvasId, chartConfig) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart if it exists
            if (activeCharts[canvasId]) {
                activeCharts[canvasId].destroy();
            }
            
            const config = {
                type: chartConfig.type,
                data: {
                    labels: chartConfig.data.labels,
                    datasets: [{
                        label: chartConfig.title,
                        data: chartConfig.data.values,
                        backgroundColor: chartConfig.config.backgroundColor,
                        borderColor: chartConfig.config.borderColor,
                        borderWidth: 2,
                        fill: chartConfig.config.fill || false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: chartConfig.type !== 'pie'
                        },
                        title: {
                            display: false
                        }
                    },
                    scales: chartConfig.type !== 'pie' ? {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(218, 220, 224, 0.3)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    } : {}
                }
            };
            
            activeCharts[canvasId] = new Chart(ctx, config);
        }
        
        function generateInsights(insights) {
            const insightsSection = document.getElementById('insightsSection');
            const insightsList = document.getElementById('insightsList');
            
            if (!insightsSection || !insightsList || !insights.length) return;
            
            let insightsHTML = '';
            insights.forEach(insight => {
                insightsHTML += `
                    <div class="insight-item">
                        <span class="material-icons insight-icon">lightbulb</span>
                        <div class="insight-text">${insight}</div>
                    </div>
                `;
            });
            
            insightsList.innerHTML = insightsHTML;
            insightsSection.style.display = 'block';
        }
        
        function generateForecast(forecast) {
            const forecastSection = document.getElementById('forecastSection');
            const forecastContent = document.getElementById('forecastContent');
            
            if (!forecastSection || !forecastContent) return;
            
            const trendIcon = forecast.trend === 'increasing' ? 'trending_up' : 
                            forecast.trend === 'decreasing' ? 'trending_down' : 'trending_flat';
            
            const trendClass = forecast.trend === 'increasing' ? 'trend-up' : 
                             forecast.trend === 'decreasing' ? 'trend-down' : 'trend-stable';
            
            let forecastHTML = `
                <div class="forecast-values">
                    <div class="forecast-trend ${trendClass}">
                        <span class="material-icons">${trendIcon}</span>
                        ${forecast.trend.charAt(0).toUpperCase() + forecast.trend.slice(1)} Trend
                    </div>
                    <div class="forecast-next-values">
                        <strong>Next 3 periods forecast:</strong><br>
                        ${forecast.next_values.join(', ')}
                    </div>
                    <div class="forecast-confidence">Confidence: ${forecast.confidence}</div>
                </div>
                <div class="forecast-values">
                    <h4 style="margin-bottom: 12px; color: #1a73e8;">Trend Analysis</h4>
                    <p style="font-size: 14px; color: #5f6368; margin-bottom: 8px;">
                        Slope: ${forecast.slope > 0 ? '+' : ''}${forecast.slope}
                    </p>
                    <p style="font-size: 13px; color: #5f6368;">
                        Based on historical data patterns, the forecast indicates a 
                        <strong>${forecast.trend}</strong> trend with ${forecast.confidence.toLowerCase()} confidence.
                    </p>
                </div>
            `;
            
            forecastContent.innerHTML = forecastHTML;
            forecastSection.style.display = 'block';
        }
        
        function switchDashboardTab(tabName) {
            currentDashboardTab = tabName;
            
            // Update active tab
            document.querySelectorAll('.dashboard-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Show/hide sections based on tab
            const kpiGrid = document.getElementById('kpiGrid');
            const metricsGrid = document.getElementById('metricsGrid');
            const chartsGrid = document.getElementById('chartsGrid');
            const insightsSection = document.getElementById('insightsSection');
            const forecastSection = document.getElementById('forecastSection');
            
            // Hide all sections first
            [kpiGrid, metricsGrid, chartsGrid, insightsSection, forecastSection].forEach(section => {
                if (section) section.style.display = 'none';
            });
            
            // Show sections based on tab
            if (tabName === 'overview') {
                if (kpiGrid) kpiGrid.style.display = 'grid';
                if (metricsGrid) metricsGrid.style.display = 'grid';
                if (insightsSection) insightsSection.style.display = 'block';
            } else if (tabName === 'charts') {
                if (chartsGrid) chartsGrid.style.display = 'grid';
            } else if (tabName === 'forecast') {
                if (forecastSection) forecastSection.style.display = 'block';
            }
        }
        
        function refreshDashboard() {
            const refreshBtn = document.getElementById('refreshDashboard');
            if (refreshBtn) {
                refreshBtn.innerHTML = '<span class="loading-spinner"></span> Refreshing...';
                
                setTimeout(() => {
                    if (currentDashboardData) {
                        generateDynamicDashboard(currentDashboardData, 'Current Table');
                    }
                    refreshBtn.innerHTML = '<span class="material-icons">refresh</span> Refresh';
                }, 1000);
            }
        }
        
        function exportChart(chartId) {
            const chart = activeCharts[chartId];
            if (chart) {
                const url = chart.toBase64Image();
                const link = document.createElement('a');
                link.download = `${chartId}.png`;
                link.href = url;
                link.click();
            }
        }
        
        function refreshChart(chartId) {
            const chart = activeCharts[chartId];
            if (chart) {
                chart.update();
            }
        }

        function formatAIResponse(text) {
            // Clean up excessive spacing and normalize text
            let formatted = text
                .replace(/\n\s*\n\s*\n/g, '\n\n') // Reduce multiple line breaks to double
                .replace(/^\s+|\s+$/g, '') // Trim whitespace
                .trim();

            // COMPLETELY REMOVE SQL-related content
            formatted = formatted
                // Remove SQL query sections entirely
                .replace(/SQL Query[:\s]*[\s\S]*?(?=\n\n[A-Z]|\n[A-Z][a-z]|$)/gi, '')
                .replace(/SQL Queries[:\s]*[\s\S]*?(?=\n\n[A-Z]|\n[A-Z][a-z]|$)/gi, '')
                // Remove code blocks
                .replace(/```[\s\S]*?```/g, '')
                .replace(/``[\s\S]*?``/g, '')
                .replace(/`[^`]*`/g, '')
                // Remove SELECT statements
                .replace(/SELECT[\s\S]*?;/gi, '')
                .replace(/SELECT[\s\S]*?(?=\n\n|$)/gi, '')
                // Clean up extra whitespace
                .replace(/\n\s*\n\s*\n/g, '\n\n');

            // Convert markdown-like formatting to HTML with enhanced styling
            formatted = formatted
                // Bold text
                .replace(/\*\*(.*?)\*\*/g, '<strong class="highlight-text">$1</strong>')
                // Headers with better styling
                .replace(/^### (.*$)/gm, '<div class="section-header level-3"><span class="material-icons">label</span>$1</div>')
                .replace(/^## (.*$)/gm, '<div class="section-header level-2"><span class="material-icons">topic</span>$1</div>')
                .replace(/^# (.*$)/gm, '<div class="section-header level-1"><span class="material-icons">star</span>$1</div>');

            // Handle numbered lists and bullet points with enhanced styling
            const lines = formatted.split('\n');
            let htmlLines = [];
            let inOrderedList = false;
            let inUnorderedList = false;
            let currentSection = null;
            let skipSection = false;

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];
                const trimmedLine = line.trim();
                
                // Skip empty lines
                if (trimmedLine === '') {
                    if (inOrderedList || inUnorderedList) {
                        continue; // Don't break lists with empty lines
                    }
                    htmlLines.push('');
                    currentSection = null;
                    skipSection = false;
                    continue;
                }
                
                // Skip SQL-related sections and visualization suggestions
                if (trimmedLine.toLowerCase().includes('sql') || 
                    trimmedLine.toLowerCase().includes('select') ||
                    trimmedLine.toLowerCase().includes('from') ||
                    trimmedLine.toLowerCase().includes('query') ||
                    trimmedLine.toLowerCase().includes('visualization') ||
                    trimmedLine.toLowerCase().includes('chart type')) {
                    skipSection = true;
                    continue;
                }
                
                if (skipSection && !trimmedLine.match(/^[A-Z][a-z ]+:/)) {
                    continue; // Keep skipping until we hit a new section
                }
                skipSection = false;
                
                // Skip hardcoded metrics sections entirely
                if (trimmedLine.includes('Important Metrics') || 
                    trimmedLine.toLowerCase().includes('rating: a measure') ||
                    trimmedLine.toLowerCase().includes('viewers (millions)') ||
                    trimmedLine.toLowerCase().includes('share percent') ||
                    trimmedLine.toLowerCase().includes('network: the television')) {
                    skipSection = true;
                    continue;
                }
                
                // Detect section types for better formatting
                if (trimmedLine.includes('Analysis:') || trimmedLine.includes('Executive Summary') || 
                    trimmedLine.includes('Key Insights') || trimmedLine.includes('Chart Types') || 
                    trimmedLine.includes('KPIs') || trimmedLine.includes('Recommendations') || 
                    trimmedLine.includes('Visualization')) {
                    currentSection = trimmedLine.toLowerCase().includes('insight') ? 'insights' : 
                                   trimmedLine.toLowerCase().includes('recommend') ? 'recommendations' : 
                                   trimmedLine.toLowerCase().includes('chart') || trimmedLine.toLowerCase().includes('visual') ? 'insights' : 'summary';
                }
                
                // Handle circle as bullet points (AI is using 'circle' instead of proper bullets)
                if (trimmedLine.startsWith('circle')) {
                    const content = trimmedLine.replace(/^circle\s*/, '');
                    if (!inUnorderedList) {
                        if (inOrderedList) {
                            htmlLines.push('</ol>');
                            inOrderedList = false;
                        }
                        htmlLines.push(`<ul class="formatted-list bullet-list ${currentSection || ''}">`);
                        inUnorderedList = true;
                    }
                    const icon = currentSection === 'insights' ? 'lightbulb' : 
                               currentSection === 'recommendations' ? 'recommend' : 'analytics';
                    htmlLines.push(`<li class="list-item"><span class="material-icons list-icon">${icon}</span>${content}</li>`);
                }
                else if (/^\d+\.\s+/.test(trimmedLine)) {
                    // Numbered list item
                    if (!inOrderedList) {
                        if (inUnorderedList) {
                            htmlLines.push('</ul>');
                            inUnorderedList = false;
                        }
                        htmlLines.push(`<ol class="formatted-list ${currentSection || ''}">`);
                        inOrderedList = true;
                    }
                    const content = trimmedLine.replace(/^\d+\.\s+/, '');
                    htmlLines.push(`<li class="list-item">${content}</li>`);
                } else if (/^[\*\-•]\s+/.test(trimmedLine)) {
                    // Bulleted list item with icons
                    if (!inUnorderedList) {
                        if (inOrderedList) {
                            htmlLines.push('</ol>');
                            inOrderedList = false;
                        }
                        htmlLines.push(`<ul class="formatted-list bullet-list ${currentSection || ''}">`);
                        inUnorderedList = true;
                    }
                    const content = trimmedLine.replace(/^[\*\-•]\s+/, '');
                    const icon = currentSection === 'insights' ? 'lightbulb' : 
                               currentSection === 'recommendations' ? 'recommend' : 'analytics';
                    htmlLines.push(`<li class="list-item"><span class="material-icons list-icon">${icon}</span>${content}</li>`);
                } else {
                    // Regular line or section header
                    if (inOrderedList) {
                        htmlLines.push('</ol>');
                        inOrderedList = false;
                    }
                    if (inUnorderedList) {
                        htmlLines.push('</ul>');
                        inUnorderedList = false;
                    }
                    
                    if (!trimmedLine.startsWith('<div class="section-header')) {
                        const paragraphClass = currentSection ? `paragraph ${currentSection}` : 'paragraph';
                        htmlLines.push(`<p class="${paragraphClass}">${line}</p>`);
                    } else {
                        htmlLines.push(line);
                    }
                }
            }
            
            // Close any open lists
            if (inOrderedList) htmlLines.push('</ol>');
            if (inUnorderedList) htmlLines.push('</ul>');
            
            return htmlLines.join('\n');
        }

        function switchTab(tabName) {
            // Update active tab
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Show corresponding content area
            document.getElementById('resultsArea').style.display = tabName === 'dashboard' ? 'flex' : 'none';
            document.getElementById('chartsArea').style.display = tabName === 'charts' ? 'flex' : 'none';
            document.getElementById('settingsArea').style.display = tabName === 'settings' ? 'flex' : 'none';
        }

        let lastQueryData = null;
        let currentQuestion = '';
        let generatedCharts = false;

        function analyzeQuestionForCharts(question) {
            const q = question.toLowerCase();
            const chartTypes = [];
            
            if (q.includes('trend') || q.includes('over time') || q.includes('change') || q.includes('growth')) {
                chartTypes.push('trend');
            }
            if (q.includes('top') || q.includes('best') || q.includes('highest') || q.includes('compare')) {
                chartTypes.push('ranking');
            }
            if (q.includes('network') && (q.includes('vs') || q.includes('versus') || q.includes('compare'))) {
                chartTypes.push('comparison');
            }
            if (q.includes('average') || q.includes('mean') || q.includes('performance')) {
                chartTypes.push('performance');
            }
            if (q.includes('share') || q.includes('percentage') || q.includes('market')) {
                chartTypes.push('distribution');
            }
            
            return chartTypes.length > 0 ? chartTypes : ['overview'];
        }

        function generateChartsAutomatically(question, data) {
            if (!data || (!data.columns && !data.data)) return;
            
            const chartsContent = document.getElementById('chartsContent');
            const chartsMetadata = document.getElementById('chartsMetadata');
            
            chartsMetadata.innerHTML = `
                <span>Charts for: "${question.substring(0, 40)}${question.length > 40 ? '...' : ''}"</span>
            `;
            
            let chartsHTML = '';
            
            // Get data structure
            const dataToUse = data.data || data;
            const columns = dataToUse.columns || data.columns;
            const rows = dataToUse.rows || data.rows;
            
            if (columns && rows) {
                // Use AI suggestions if available, otherwise generate smart charts
                if (data.chart_suggestions && data.chart_suggestions.length > 0) {
                    data.chart_suggestions.forEach(suggestion => {
                        chartsHTML += generateActualChart(suggestion, columns, rows);
                    });
                } else {
                    // Generate smart chart based on data
                    chartsHTML += generateSmartChart(columns, rows, question);
                }
            }
            
            chartsContent.innerHTML = chartsHTML || `
                <div class="empty-state">
                    <span class="material-icons">insert_chart</span>
                    <h3>No data to visualize</h3>
                </div>
            `;
            
            generatedCharts = true;
        }

        // Generate smart chart based on data structure
        function generateSmartChart(columns, rows, question) {
            // Find the best columns for visualization
            const numericColumns = columns.filter((col, index) => {
                const sampleValue = rows[0] && rows[0][index];
                return typeof sampleValue === 'number' || !isNaN(parseFloat(sampleValue));
            });
            
            const categoryColumns = columns.filter((col, index) => {
                const sampleValue = rows[0] && rows[0][index];
                return typeof sampleValue === 'string' && isNaN(parseFloat(sampleValue));
            });
            
            if (categoryColumns.length > 0 && numericColumns.length > 0) {
                return generateActualBarChart(categoryColumns[0], numericColumns[0], columns, rows);
            } else if (numericColumns.length >= 2) {
                return generateActualBarChart(columns[0], numericColumns[0], columns, rows);
            }
            
            return generateDataSummary(columns, rows);
        }
        
        // Generate actual chart from AI suggestion
        function generateActualChart(suggestion, columns, rows) {
            switch(suggestion.type) {
                case 'bar_chart':
                    const xCol = suggestion.x_axis || columns[0];
                    const yCol = suggestion.y_axis || columns[1];
                    return generateActualBarChart(xCol, yCol, columns, rows, suggestion.title);
                case 'line_chart':
                    return generateActualLineChart(suggestion, columns, rows);
                default:
                    return generateActualBarChart(columns[0], columns[1], columns, rows, suggestion.title);
            }
        }
        
        // Generate actual bar chart with real data
        function generateActualBarChart(xColumn, yColumn, columns, rows, title = null) {
            const xIndex = columns.indexOf(xColumn);
            const yIndex = columns.indexOf(yColumn);
            
            if (xIndex === -1 || yIndex === -1) {
                return generateDataSummary(columns, rows);
            }
            
            // Process data
            const dataMap = {};
            rows.forEach(row => {
                const xValue = String(row[xIndex] || 'Unknown');
                const yValue = parseFloat(row[yIndex]) || 0;
                
                if (dataMap[xValue]) {
                    dataMap[xValue] += yValue;
                } else {
                    dataMap[xValue] = yValue;
                }
            });
            
            // Sort by value and take top 8
            const sortedData = Object.entries(dataMap)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 8);
            
            const maxValue = Math.max(...sortedData.map(([,value]) => value));
            
            let barsHTML = '';
            sortedData.forEach(([label, value], i) => {
                const height = maxValue > 0 ? (value / maxValue) * 100 : 10;
                const hue = 210 + (i * 25);
                const color = `hsl(${hue}, 70%, 55%)`;
                
                barsHTML += `
                    <div class="bar" style="height: ${height}%; background: linear-gradient(to top, ${color}, ${color}dd);">
                        <div class="bar-value">${value.toFixed(1)}</div>
                        <div class="bar-label">${label.length > 10 ? label.substring(0, 8) + '...' : label}</div>
                    </div>
                `;
            });
            
            const chartTitle = title || `${xColumn} by ${yColumn}`;
            
            return `
                <div class="chart-container">
                    <div class="chart-title">
                        <span class="material-icons">bar_chart</span>
                        ${chartTitle}
                    </div>
                    <div class="bar-chart">
                        ${barsHTML}
                    </div>
                </div>
            `;
        }
        
        // Generate actual line chart (trend analysis)
        function generateActualLineChart(suggestion, columns, rows) {
            const xIndex = columns.indexOf(suggestion.x_axis);
            const yIndex = columns.indexOf(suggestion.y_axis);
            
            if (xIndex === -1 || yIndex === -1) {
                return generateDataSummary(columns, rows);
            }
            
            // Calculate trend
            const values = rows.map(row => parseFloat(row[yIndex]) || 0);
            const firstValue = values[0] || 0;
            const lastValue = values[values.length - 1] || 0;
            const avgValue = values.reduce((a, b) => a + b, 0) / values.length;
            
            const trendDirection = lastValue > firstValue ? 'up' : lastValue < firstValue ? 'down' : 'stable';
            const trendPercent = firstValue !== 0 ? ((lastValue - firstValue) / firstValue * 100).toFixed(1) : '0';
            
            return `
                <div class="chart-container">
                    <div class="chart-title">
                        <span class="material-icons">show_chart</span>
                        ${suggestion.title}
                    </div>
                    <div class="trend-line">
                        <div class="trend-indicator trend-${trendDirection}">
                            <span class="material-icons">trending_${trendDirection === 'stable' ? 'flat' : trendDirection}</span>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 600; margin-bottom: 8px;">
                                    ${trendPercent}%
                                </div>
                                <div style="font-size: 14px; margin-bottom: 4px;">
                                    ${firstValue.toFixed(1)} → ${lastValue.toFixed(1)}
                                </div>
                                <div style="font-size: 12px; opacity: 0.7;">
                                    Avg: ${avgValue.toFixed(1)} • ${rows.length} points
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Generate data summary when charts can't be created
        function generateDataSummary(columns, rows) {
            const numericColumns = columns.filter((col, index) => {
                const sampleValue = rows[0] && rows[0][index];
                return typeof sampleValue === 'number' || !isNaN(parseFloat(sampleValue));
            });
            
            return `
                <div class="chart-container">
                    <div class="chart-title">
                        <span class="material-icons">analytics</span>
                        Data Overview
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; padding: 20px;">
                        <div style="text-align: center; padding: 16px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 28px; font-weight: 600; color: #1a73e8;">${rows.length}</div>
                            <div style="font-size: 12px; color: #5f6368;">Records</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 28px; font-weight: 600; color: #34a853;">${columns.length}</div>
                            <div style="font-size: 12px; color: #5f6368;">Columns</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 28px; font-weight: 600; color: #ea4335;">${numericColumns.length}</div>
                            <div style="font-size: 12px; color: #5f6368;">Numeric</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateTrendChart(columns, rows) {
            return `
                <div class="chart-container">
                    <div class="chart-title">
                        <span class="material-icons">trending_up</span>
                        Trend Analysis
                    </div>
                    <div class="trend-line">
                        <div class="trend-indicator trend-up">
                            <span class="material-icons">trending_up</span>
                            <span>Trend visualization would show temporal changes in your data</span>
                        </div>
                    </div>
                    <p style="color: #5f6368; font-size: 12px; text-align: center;">
                        Interactive trend chart ready for integration with Chart.js or D3.js
                    </p>
                </div>
            `;
        }

        function generateRankingChart(columns, rows) {
            // Find the best columns for ranking
            const labelColumn = columns[0]; // First column as labels
            const valueColumn = columns.find(col => 
                col.toLowerCase().includes('rating') || 
                col.toLowerCase().includes('viewers') || 
                col.toLowerCase().includes('share') ||
                col.toLowerCase().includes('average')
            ) || columns[1]; // Default to second column
            
            const labelIndex = columns.indexOf(labelColumn);
            const valueIndex = columns.indexOf(valueColumn);
            
            // Create a simple bar chart with actual data
            const maxBars = Math.min(8, rows.length);
            const dataPoints = rows.slice(0, maxBars).map(row => ({
                label: String(row[labelIndex] || 'Unknown'),
                value: parseFloat(row[valueIndex]) || 0
            }));
            
            const maxValue = Math.max(...dataPoints.map(d => d.value));
            
            let barsHTML = '';
            dataPoints.forEach((point, i) => {
                const height = maxValue > 0 ? (point.value / maxValue) * 100 : 10;
                const color = `hsl(${210 + i * 15}, 70%, 50%)`; // Different colors for each bar
                
                barsHTML += `
                    <div class="bar" style="height: ${height}%; background: linear-gradient(to top, ${color}, ${color}aa);">
                        <div class="bar-value">${point.value.toFixed(1)}</div>
                        <div class="bar-label">${point.label.length > 15 ? point.label.substring(0, 12) + '...' : point.label}</div>
                    </div>
                `;
            });
            
            return `
                <div class="chart-container">
                    <div class="chart-title">
                        <span class="material-icons">bar_chart</span>
                        ${labelColumn} vs ${valueColumn}
                    </div>
                    <div class="bar-chart">
                        ${barsHTML}
                    </div>
                    <p style="color: #5f6368; font-size: 12px; text-align: center;">
                        Showing top ${maxBars} entries by ${valueColumn}
                    </p>
                </div>
            `;
        }

        function generateOverviewChart(columns, rows) {
            // Generate multiple charts for overview
            let chartsHTML = '';
            
            // Find numeric columns
            const numericColumns = columns.filter((col, index) => {
                const sampleValue = rows[0] && rows[0][index];
                return typeof sampleValue === 'number' || !isNaN(parseFloat(sampleValue));
            });
            
            if (numericColumns.length > 0) {
                // Create a chart for the first numeric column
                const firstNumericCol = numericColumns[0];
                const colIndex = columns.indexOf(firstNumericCol);
                const labelCol = columns[0]; // Use first column as labels
                
                const dataPoints = rows.slice(0, 6).map(row => ({
                    label: String(row[0] || 'Unknown'),
                    value: parseFloat(row[colIndex]) || 0
                }));
                
                const maxValue = Math.max(...dataPoints.map(d => d.value));
                
                let barsHTML = '';
                dataPoints.forEach((point, i) => {
                    const height = maxValue > 0 ? (point.value / maxValue) * 100 : 10;
                    
                    barsHTML += `
                        <div class="bar" style="height: ${height}%;">
                            <div class="bar-value">${point.value.toFixed(1)}</div>
                            <div class="bar-label">${point.label.length > 10 ? point.label.substring(0, 8) + '...' : point.label}</div>
                        </div>
                    `;
                });
                
                chartsHTML += `
                    <div class="chart-container">
                        <div class="chart-title">
                            <span class="material-icons">insights</span>
                            ${labelCol} by ${firstNumericCol}
                        </div>
                        <div class="bar-chart">
                            ${barsHTML}
                        </div>
                        <p style="color: #5f6368; font-size: 12px; text-align: center;">
                            Overview of ${rows.length} records
                        </p>
                    </div>
                `;
            }
            
            // Add data summary table
            chartsHTML += `
                <div class="chart-container">
                    <div class="chart-title">
                        <span class="material-icons">table_view</span>
                        Data Summary
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; padding: 16px;">
                        <div style="text-align: center; padding: 16px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 500; color: #1a73e8;">${rows.length}</div>
                            <div style="font-size: 12px; color: #5f6368;">Total Records</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 500; color: #34a853;">${columns.length}</div>
                            <div style="font-size: 12px; color: #5f6368;">Data Columns</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 500; color: #ea4335;">${numericColumns.length}</div>
                            <div style="font-size: 12px; color: #5f6368;">Numeric Fields</div>
                        </div>
                    </div>
                    <div style="margin-top: 16px; padding: 12px; background: rgba(26, 115, 232, 0.1); border-radius: 6px;">
                        <strong>Columns:</strong> ${columns.join(', ')}
                    </div>
                </div>
            `;
            
            return chartsHTML;
        }

        function generateTrendChart(columns, rows) {
            // Look for date/time columns and numeric columns
            const dateColumns = columns.filter(col => 
                col.toLowerCase().includes('date') || 
                col.toLowerCase().includes('time') || 
                col.toLowerCase().includes('week')
            );
            
            const numericColumns = columns.filter((col, index) => {
                const sampleValue = rows[0] && rows[0][index];
                return typeof sampleValue === 'number' || !isNaN(parseFloat(sampleValue));
            });
            
            if (dateColumns.length > 0 && numericColumns.length > 0) {
                const dateCol = dateColumns[0];
                const valueCol = numericColumns[0];
                const dateIndex = columns.indexOf(dateCol);
                const valueIndex = columns.indexOf(valueCol);
                
                // Calculate trend direction
                const firstValue = parseFloat(rows[0][valueIndex]) || 0;
                const lastValue = parseFloat(rows[rows.length - 1][valueIndex]) || 0;
                const trendDirection = lastValue > firstValue ? 'up' : lastValue < firstValue ? 'down' : 'stable';
                const trendPercent = firstValue !== 0 ? ((lastValue - firstValue) / firstValue * 100).toFixed(1) : '0';
                
                return `
                    <div class="chart-container">
                        <div class="chart-title">
                            <span class="material-icons">trending_${trendDirection === 'stable' ? 'flat' : trendDirection}</span>
                            ${valueCol} Trend Over ${dateCol}
                        </div>
                        <div class="trend-line">
                            <div class="trend-indicator trend-${trendDirection}">
                                <span class="material-icons">trending_${trendDirection === 'stable' ? 'flat' : trendDirection}</span>
                                <div style="text-align: center;">
                                    <div style="font-size: 18px; font-weight: 500;">
                                        ${trendPercent}% ${trendDirection === 'up' ? 'increase' : trendDirection === 'down' ? 'decrease' : 'stable'}
                                    </div>
                                    <div style="font-size: 12px; margin-top: 4px;">
                                        From ${firstValue.toFixed(1)} to ${lastValue.toFixed(1)}
                                    </div>
                                    <div style="font-size: 10px; margin-top: 4px; opacity: 0.7;">
                                        Across ${rows.length} time periods
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return this.generateOverviewChart(columns, rows);
        }

        function generateComparisonChart(columns, rows) {
            // Look for network or category columns
            const categoryCol = columns.find(col => 
                col.toLowerCase().includes('network') || 
                col.toLowerCase().includes('category') || 
                col.toLowerCase().includes('show')
            ) || columns[0];
            
            const valueCol = columns.find(col => 
                col.toLowerCase().includes('rating') || 
                col.toLowerCase().includes('average') || 
                col.toLowerCase().includes('viewers')
            ) || columns[1];
            
            const categoryIndex = columns.indexOf(categoryCol);
            const valueIndex = columns.indexOf(valueCol);
            
            // Group by category and calculate averages
            const categoryData = {};
            rows.forEach(row => {
                const category = String(row[categoryIndex] || 'Unknown');
                const value = parseFloat(row[valueIndex]) || 0;
                
                if (!categoryData[category]) {
                    categoryData[category] = { total: 0, count: 0, values: [] };
                }
                categoryData[category].total += value;
                categoryData[category].count += 1;
                categoryData[category].values.push(value);
            });
            
            // Calculate averages and create chart
            const comparisonData = Object.entries(categoryData).map(([category, data]) => ({
                category,
                average: data.total / data.count,
                count: data.count
            })).sort((a, b) => b.average - a.average);
            
            const maxValue = Math.max(...comparisonData.map(d => d.average));
            
            let barsHTML = '';
            comparisonData.forEach((item, i) => {
                const height = (item.average / maxValue) * 100;
                const color = i === 0 ? '#34a853' : i === 1 ? '#fbbc04' : '#ea4335';
                
                barsHTML += `
                    <div class="bar" style="height: ${height}%; background: linear-gradient(to top, ${color}, ${color}aa);">
                        <div class="bar-value">${item.average.toFixed(2)}</div>
                        <div class="bar-label">${item.category}</div>
                    </div>
                `;
            });
            
            return `
                <div class="chart-container">
                    <div class="chart-title">
                        <span class="material-icons">compare_arrows</span>
                        ${categoryCol} Comparison by ${valueCol}
                    </div>
                    <div class="bar-chart">
                        ${barsHTML}
                    </div>
                    <p style="color: #5f6368; font-size: 12px; text-align: center;">
                        Average ${valueCol} by ${categoryCol}
                    </p>
                </div>
            `;
        }

        function refreshCharts() {
            if (lastQueryData && currentQuestion) {
                generateChartsAutomatically(currentQuestion, lastQueryData);
            }
        }

        function generateDataTable(data) {
            if (!data.columns || !data.rows) return '';
            
            let table = `<div class="response-content">
                <h3 style="margin-bottom: 16px; font-size: 16px; font-weight: 500; color: #202124;">Query Results</h3>
                <table class="data-table">
                    <thead><tr>`;
            
            data.columns.forEach(col => {
                table += `<th>${col}</th>`;
            });
            
            table += `</tr></thead><tbody>`;
            
            data.rows.forEach(row => {
                table += `<tr>`;
                row.forEach(cell => {
                    table += `<td>${cell !== null ? cell : ''}</td>`;
                });
                table += `</tr>`;
            });
            
            table += `</tbody></table></div>`;
            return table;
        }

        function displayError(errorMessage) {
            const resultsContent = document.getElementById('resultsContent');
            const metadata = document.getElementById('resultsMetadata');
            
            metadata.innerHTML = `<span>Error occurred at ${new Date().toLocaleString()}</span>`;
            
            resultsContent.innerHTML = `
                <div class="error-state">
                    <span class="material-icons">error</span>
                    <span>${errorMessage}</span>
                </div>
                <div class="empty-state">
                    <span class="material-icons">psychology</span>
                    <h3>Ready to try again</h3>
                    <p>Please check your query and try again, or select an example question to get started.</p>
                </div>
            `;
        }

        function clearResults() {
            if (isProcessing) return;
            
            const resultsContent = document.getElementById('resultsContent');
            const metadata = document.getElementById('resultsMetadata');
            
            resultsContent.innerHTML = `
                <div class="empty-state">
                    <span class="material-icons">psychology</span>
                    <h3>Ready to analyze your data</h3>
                    <p>Ask a question about your TV ratings data using natural language, or execute a custom SQL query to get started.</p>
                </div>
            `;
            
            metadata.innerHTML = '';
            document.getElementById('questionInput').value = '';
            document.getElementById('sqlInput').value = '';
            updateStatus('ready', 'Ready');
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + Enter to submit
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                if (document.activeElement === document.getElementById('questionInput')) {
                    submitQuestion();
                } else if (document.activeElement === document.getElementById('sqlInput')) {
                    executeSql();
                }
            }
            
            // Escape to cancel
            if (e.key === 'Escape' && isProcessing) {
                cancelRequest();
            }
            
            // Ctrl/Cmd + K to focus search
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                document.getElementById('questionInput').focus();
            }
        });

        // Mobile sidebar toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }

        // Handle window resize
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                document.getElementById('sidebar').classList.remove('open');
            }
        });

        // Prevent form submission on Enter (except with Ctrl/Cmd)
        document.getElementById('questionInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.ctrlKey && !e.metaKey) {
                e.preventDefault();
            }
        });

        document.getElementById('sqlInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.ctrlKey && !e.metaKey) {
                e.preventDefault();
            }
        });

        // Auto-save draft functionality (optional enhancement)
        let draftTimeout;
        document.getElementById('questionInput').addEventListener('input', function(e) {
            clearTimeout(draftTimeout);
            draftTimeout = setTimeout(() => {
                localStorage.setItem('tv-analytics-draft', e.target.value);
            }, 1000);
        });

        // Load draft on page load
        window.addEventListener('load', function() {
            const draft = localStorage.getItem('tv-analytics-draft');
            if (draft && draft.trim()) {
                document.getElementById('questionInput').value = draft;
                autoResizeTextarea({target: document.getElementById('questionInput')});
            }
        });

        // Clear draft when question is submitted
        function clearDraft() {
            localStorage.removeItem('tv-analytics-draft');
        }

        // Update the submitQuestion function to clear draft
        const originalSubmitQuestion = submitQuestion;
        submitQuestion = async function() {
            clearDraft();
            return originalSubmitQuestion();
        };

        // Handle navigation tabs (for future enhancement)
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                if (isProcessing) return;
                
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Future: Switch between different views/sections
                const tabText = this.textContent;
                console.log(`Switched to ${tabText} tab`);
            });
        });

        // Performance monitoring (optional)
        let startTime;
        function startPerformanceMonitoring() {
            startTime = performance.now();
        }

        function endPerformanceMonitoring(operation) {
            if (startTime) {
                const duration = Math.round(performance.now() - startTime);
                console.log(`${operation} completed in ${duration}ms`);
                startTime = null;
            }
        }

        // Add performance monitoring to requests
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            startPerformanceMonitoring();
            return originalFetch.apply(this, args).finally(() => {
                endPerformanceMonitoring('API Request');
            });
        };

        // Error boundary for JavaScript errors
        window.addEventListener('error', function(e) {
            console.error('JavaScript Error:', e.error);
            updateStatus('error', 'Application error');
            
            // Show user-friendly error message
            if (isProcessing) {
                displayError('An unexpected error occurred. Please try again.');
                setProcessingState(false);
            }
        });

        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled Promise Rejection:', e.reason);
            updateStatus('error', 'Application error');
            
            if (isProcessing) {
                displayError('An unexpected error occurred. Please try again.');
                setProcessingState(false);
            }
        });

        // Service worker registration (for future PWA features)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                // Future: Register service worker for offline functionality
                console.log('Service Worker support detected');
            });
        }






        // Add mobile hamburger menu for responsive design
        if (window.innerWidth <= 768) {
            const navLeft = document.querySelector('.nav-left');
            const hamburger = document.createElement('button');
            hamburger.innerHTML = '<span class="material-icons">menu</span>';
            hamburger.className = 'btn';
            hamburger.style.cssText = 'min-width: 40px; padding: 8px; margin-right: 12px;';
            hamburger.onclick = toggleSidebar;
            navLeft.insertBefore(hamburger, navLeft.firstChild);
        }
    </script>
</body>
</html>
